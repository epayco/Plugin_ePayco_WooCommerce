/* jshint es3: false */
/* globals wc_epayco_Subscription_checkout_params, CheckoutSubscriptionElements, CheckoutSubscriptionPage */
(function ($) {
    'use strict';
    $(function () {
        var epayco_submit = false;

        function  epaycoFormHandler() {
            var publicKey = wc_epayco_subscription_checkout_params.public_key_epayco;
            ePayco.setPublicKey(publicKey);
            ePayco.setLanguage("es");
            let formOrderReview = document.querySelector('form[id=order_review]');
            if (formOrderReview) {
                let choCustomContent = document.querySelector('.ep-checkout-subscription-container');
                let choCustomHelpers = choCustomContent.querySelectorAll('input-helper');

                choCustomHelpers.forEach((item) => {
                    let inputHelper = item.querySelector('div');
                    if (inputHelper.style.display !== 'none') {
                        removeBlockOverlay();
                    }
                });
            }
            var CustomContent = document.querySelector("form.checkout").getElementsByClassName("ep-checkout-subscription-container")[0];
            let ticketHelpers = CustomContent.querySelectorAll('input-helper');
            numberName(CustomContent)
            expirationDate(CustomContent)
            securityCode(CustomContent)
            verifyName(CustomContent)
            verifyEmail(CustomContent)
            verifyAddress(CustomContent)
            verifyCellphone(CustomContent)
            verifyDocument(CustomContent)
            verifyCountry(CustomContent)
            verifyTermAndCondictions(CustomContent)
            let checked =  CustomContent.querySelector('terms-and-conditions').querySelector('input').checked
            if (checkForErrors(ticketHelpers) || !checked) {
                removeBlockOverlay();
                return epayco_submit;
            } else {
                const request =  createToken(CustomContent);
                request().then((resultado) => {
                    console.log(resultado); // Esto se ejecutará después de 2 segundos
                }).catch((error) => {
                    console.error(error); // Esto se ejecutará si hay un error
                });

            }


        }

        function checkForErrors(ticketHelpers) {
            let hasError = false;
            ticketHelpers.forEach((item) => {
                let inputHelper = item.querySelector('div');
                if (inputHelper.style.display !== 'none') {
                    hasError = true;
                }
            });

            return hasError;
        }

        function numberName(customContent) {
            let nameElement = customContent.querySelector('#form-checkout__cardNumber-container').querySelector('input');
            if (nameElement.value === '') {
                nameElement.parentElement.classList.add('ep-error');
                let pseHelpers = nameElement.parentElement.parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function expirationDate(customContent) {
            let nameElement = customContent.querySelector('#form-checkout__expirationDate-container').querySelector('input');
            if (nameElement.value === '') {
                nameElement.parentElement.classList.add('ep-error');
                let pseHelpers = nameElement.parentElement.parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function securityCode(customContent) {
            let nameElement = customContent.querySelector('#form-checkout__securityCode-container').querySelector('input');
            if (nameElement.value === '') {
                nameElement.parentElement.classList.add('ep-error');
                let pseHelpers = nameElement.parentElement.parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function verifyName(customContent) {
            let nameElement = customContent.querySelector('#form-checkout__identificationName-container').querySelector('input');
            if (nameElement.value === '') {
                nameElement.parentElement.classList.add('ep-error');
                let pseHelpers = nameElement.parentElement.parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function verifyEmail(customContent) {
            let emailElement = customContent.querySelector('#form-checkout__identificationEmail-container').querySelector('input');
            if (emailElement.value === '') {
                emailElement.parentElement.classList.add('ep-error');
                let pseHelpers = customContent.querySelector('#form-checkout__identificationEmail-container').parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function verifyAddress(customContent) {
            let addressElement = customContent.querySelector('#form-checkout__identificationAddress-container').querySelector('input');
            if (addressElement.value === '') {
                addressElement.parentElement.classList.add('ep-error');
                let pseHelpers = customContent.querySelector('#form-checkout__identificationAddress-container').parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function verifyCellphone(customContent) {
            let addressElement = customContent.querySelector('#form-checkout__identificationCellphone-container').querySelector('input');
            if (addressElement.value === '') {
                addressElement.parentElement.classList.add("ep-error");
                addressElement.parentElement.parentElement.firstChild.classList.add("ep-error");
                let pseHelpers = customContent.querySelector('#form-checkout__identificationCellphone-container').parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function verifyDocument(customContent) {
            let addressElement = customContent.querySelector('#form-checkout__identificationNumber-container').querySelector('input');
            if (addressElement.value === '') {
                addressElement.parentElement.classList.add("ep-error");
                addressElement.parentElement.parentElement.firstChild.classList.add("ep-error");
                let pseHelpers = customContent.querySelector('#form-checkout__identificationNumber-container').parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function verifyCountry(customContent) {
            let addressElement = customContent.querySelector('#form-checkout__identificationCountry-container').querySelector('input');
            if (addressElement.value === '') {
                addressElement.parentElement.classList.add("ep-error");
                addressElement.parentElement.parentElement.firstChild.classList.add("ep-error");
                let pseHelpers = customContent.querySelector('#form-checkout__identificationCountry-container').parentElement.querySelector('input-helper');
                let child = pseHelpers.querySelector('div');
                child.style.display = 'flex';
            }
        }

        function verifyTermAndCondictions(customContent) {
            let addressElement = customContent.querySelector('terms-and-conditions').querySelector('input');
            if (!addressElement.checked) {
                customContent.querySelector('terms-and-conditions > div').classList.add('ep-error')
            }
        }

        async function  createToken($form) {
            return await new Promise(function(resolve, reject) {
                ePayco.token.create($form, function(data) {
                    var customContent = document.querySelector("form.checkout").getElementsByClassName("ep-checkout-custom-container")[0];
                    customContent.querySelector('#form-checkout__cardNumber-container').querySelector('input').value='';
                    customContent.querySelector('#form-checkout__expirationDate-container').querySelector('input').value='';
                    customContent.querySelector('#form-checkout__securityCode-container').querySelector('input').value='';
                    if(data.status=='error'){
                        const parsedError = handleCardFormErrors(data);
                        console.error('ePayco cardForm error: ', parsedError);
                        reject(false)
                    }else{
                        document.querySelector('#cardTokenId').value = data.data.token;
                        //jQuery('form.checkout').submit();
                        resolve(true)
                    }
                });
            });
        }



        function handleCardFormErrors(cardFormErrors) {
            if (cardFormErrors.length) {
                const errors = [];
                cardFormErrors.forEach((e) => {
                    errors.push(e.description || e.message);
                });

                return errors.join(',');
            }

            return cardFormErrors.description || cardFormErrors.message;
        }

        // Process when submit the checkout form
        $('form.checkout').on('checkout_place_order_woo-epayco-subscription', function () {
            return epaycoFormHandler();
        });

        // If payment fail, retry on next checkout page
        $('form#order_review').submit(function () {
            return epaycoFormHandler();
        });

        // Remove Block Overlay from Order Review page
        function removeBlockOverlay() {
            if ($('form#order_review').length > 0) {
                $('.blockOverlay').css('display', 'none');
            }
        }

    });
})(jQuery);






